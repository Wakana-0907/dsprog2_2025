<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Purple Weather</title>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-purple: #9d7af2; --accent-purple: #6c4ab6; --soft-purple: #f4f0ff; --white: #ffffff;
        }
        body {
            font-family: 'Kosugi Maru', sans-serif; background: linear-gradient(135deg, #dcd1ff 0%, #f3f0ff 100%);
            margin: 0; padding: 20px; display: flex; justify-content: center; color: #4a3a75;
        }
        .app-container {
            background: var(--white); width: 100%; max-width: 500px; padding: 25px; border-radius: 35px;
            box-shadow: 0 15px 40px rgba(157, 122, 242, 0.15);
        }
        h2 { text-align: center; color: var(--accent-purple); font-size: 1.6rem; margin-top: 0; }
        select {
            width: 100%; padding: 15px; border-radius: 20px; border: 2px solid var(--main-purple);
            background: white; font-size: 1rem; margin-bottom: 25px; outline: none; color: var(--accent-purple);
        }
        .forecast-scroll { display: flex; flex-direction: column; gap: 12px; max-height: 75vh; overflow-y: auto; }
        .day-card { background: var(--soft-purple); border-radius: 20px; padding: 15px 20px; cursor: pointer; border: 2px solid transparent; }
        .day-card.today { border: 2px solid var(--main-purple); background: #fff; }
        .day-summary { display: flex; align-items: center; justify-content: space-between; }
        .date-info { display: flex; flex-direction: column; width: 65px; }
        .tag { font-size: 0.6rem; color: var(--main-purple); font-weight: bold; }
        .weather-info { display: flex; align-items: center; gap: 10px; flex-grow: 1; margin-left: 10px; }
        .emoji { font-size: 2.2rem; }
        .weather-text { font-size: 0.85rem; font-weight: bold; }
        .details { max-height: 0; overflow: hidden; opacity: 0; transition: 0.4s; }
        .day-card.active .details { max-height: 300px; opacity: 1; margin-top: 15px; padding-top: 15px; border-top: 2px dashed var(--main-purple); }
        .detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .detail-box { background: white; padding: 10px; border-radius: 12px; font-size: 0.8rem; text-align: center; }
        .label { display: block; font-size: 0.65rem; color: var(--main-purple); margin-bottom: 3px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--main-purple); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container">
    <h2> Â§©Ê∞ó‰∫àÂ†± </h2>
    <select id="areaSelect"><option value="">Âú∞Âüü„Çí„Åà„Çâ„Çì„Åß„Å≠</option></select>
    <div id="weatherResult" class="forecast-scroll"></div>
</div>

<script>
    const weatherMaster = {
        "100": { name: "Êô¥„Çå", emoji: "‚òÄÔ∏è" }, "101": { name: "Êô¥„ÇåÊôÇ„ÄÖÊõá„Çä", emoji: "üå§Ô∏è" }, "102": { name: "Êô¥„Çå‰∏ÄÊôÇÈõ®", emoji: "üå¶Ô∏è" },
        "200": { name: "Êõá„Çä", emoji: "‚òÅÔ∏è" }, "201": { name: "Êõá„ÇäÊôÇ„ÄÖÊô¥„Çå", emoji: "üå•Ô∏è" }, "202": { name: "Êõá„Çä‰∏ÄÊôÇÈõ®", emoji: "üåßÔ∏è" },
        "300": { name: "Èõ®", emoji: "‚òî" }, "301": { name: "Èõ®ÊôÇ„ÄÖÊô¥„Çå", emoji: "üå¶Ô∏è" }, "302": { name: "Èõ®ÊôÇ„ÄÖÊõá„Çä", emoji: "üåßÔ∏è" }, "400": { name: "Èõ™", emoji: "‚ùÑÔ∏è" }
    };

    function getWeatherInfo(val) {
        if (!val) return { name: "‰∫àÂ†±‰∏≠", emoji: "‚ú®" };
        if (weatherMaster[val]) return weatherMaster[val];
        if (val.includes('Êô¥')) return { name: val, emoji: "‚òÄÔ∏è" };
        if (val.includes('Èõ®')) return { name: val, emoji: "‚òî" };
        if (val.includes('Êõá')) return { name: val, emoji: "‚òÅÔ∏è" };
        return { name: val, emoji: "‚ú®" };
    }

    async function init() {
        const res = await fetch("https://www.jma.go.jp/bosai/common/const/area.json");
        const data = await res.json();
        Object.entries(data.offices).forEach(([code, info]) => areaSelect.add(new Option(info.name, code)));
    }

    async function fetchWeather(code) {
        if (!code) return;
        weatherResult.innerHTML = '<div class="loader"></div>';
        try {
            const res = await fetch(`https://www.jma.go.jp/bosai/forecast/data/forecast/${code}.json`);
            const data = await res.json();
            const weatherMap = {};
            const todayStr = new Date().toLocaleDateString('ja-JP');

            // 1. Êó•‰ªò„Éê„Ç±„ÉÑ„ÅÆ‰ΩúÊàê
            [...data[0].timeSeries[0].timeDefines, ...data[1].timeSeries[0].timeDefines].forEach(t => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                if(!weatherMap[d]) weatherMap[d] = { highs: [], lows: [], weather: "", rain: "" };
            });

            // 2. Ê∞óÊ∏©„ÅÆÊïëÊ∏àÂèéÈõÜ
            // Áü≠Êúü„Éá„Éº„Çø„Åã„ÇâÂèñÂæó
            data[0].timeSeries[2].timeDefines.forEach((t, i) => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                const v = parseInt(data[0].timeSeries[2].areas[0].temps[i]);
                if(!isNaN(v)) { weatherMap[d].highs.push(v); weatherMap[d].lows.push(v); }
            });
            // ÈÄ±Èñì„Éá„Éº„ÇøÔºà„Åì„Åì„ÅåÂçàÂæå„ÅÆÊïëÊ∏à„Éù„Ç§„É≥„ÉàÔºâ
            data[1].timeSeries[1].timeDefines.forEach((t, i) => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                const mx = parseInt(data[1].timeSeries[1].areas[0].tempsMax[i]);
                const mn = parseInt(data[1].timeSeries[1].areas[0].tempsMin[i]);
                if(!isNaN(mx)) weatherMap[d].highs.push(mx);
                if(!isNaN(mn)) weatherMap[d].lows.push(mn);
            });

            // 3. ÈôçÊ∞¥Á¢∫Áéá„ÅÆÊïëÊ∏àÂèéÈõÜ
            data[0].timeSeries[1].timeDefines.forEach((t, i) => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                const p = data[0].timeSeries[1].areas[0].pops[i];
                if(p !== "" && p !== undefined) weatherMap[d].rain = p;
            });
            // ÈÄ±Èñì‰∫àÂ†±ÂÅ¥„ÅÆÈôçÊ∞¥Á¢∫Áéá„Åß„Äå‰ªäÊó•„Äç„ÅÆÁ©∫Ê¨Ñ„ÇíÂüã„ÇÅ„Çã
            data[1].timeSeries[0].timeDefines.forEach((t, i) => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                if(!weatherMap[d].rain) weatherMap[d].rain = data[1].timeSeries[0].areas[0].pops[i];
            });

            // Â§©Ê∞ó
            data[0].timeSeries[0].timeDefines.forEach((t, i) => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                weatherMap[d].weather = data[0].timeSeries[0].areas[0].weathers[i];
            });
            data[1].timeSeries[0].timeDefines.forEach((t, i) => {
                const d = new Date(t).toLocaleDateString('ja-JP');
                if(!weatherMap[d].weather) weatherMap[d].weather = data[1].timeSeries[0].areas[0].weatherCodes[i];
            });

            let html = '';
            Object.keys(weatherMap).sort((a,b)=>new Date(a)-new Date(b)).slice(0, 7).forEach(dStr => {
                const d = weatherMap[dStr];
                const info = getWeatherInfo(d.weather);
                const isToday = dStr === todayStr;
                const dateObj = new Date(dStr);

                let high = d.highs.length > 0 ? Math.max(...d.highs) : "--";
                let low = d.lows.length > 0 ? Math.min(...d.lows) : "--";

                html += `
                    <div class="day-card ${isToday ? 'today' : ''}" onclick="this.classList.toggle('active')">
                        <div class="day-summary">
                            <div class="date-info">
                                <span class="tag">${isToday ? 'TODAY' : ''}</span>
                                <span class="date">${dateObj.getMonth()+1}/${dateObj.getDate()}</span>
                                <span class="day">${dateObj.toLocaleDateString('ja-JP',{weekday:'short'})}</span>
                            </div>
                            <div class="weather-info"><span class="emoji">${info.emoji}</span><span class="weather-text">${info.name}</span></div>
                            <div style="text-align:right"><span style="color:#ff6b6b; font-weight:bold">${high}¬∞</span><br><span style="color:#4dabf7; font-weight:bold">${low}¬∞</span></div>
                        </div>
                        <div class="details"><div class="detail-row">
                            <div class="detail-box"><span class="label">ÊúÄÈ´òÊ∞óÊ∏©</span>${high}Â∫¶</div>
                            <div class="detail-box"><span class="label">ÊúÄ‰ΩéÊ∞óÊ∏©</span>${low}Â∫¶</div>
                            <div class="detail-box" style="grid-column: span 2;"><span class="label">ÈôçÊ∞¥Á¢∫Áéá</span> ${d.rain || '0'}% </div>
                        </div></div>
                    </div>`;
            });
            weatherResult.innerHTML = html;
        } catch (e) { weatherResult.innerHTML = 'Âú∞Âüü„ÇíÈÅ∏„Å≥„Å™„Åä„Åó„Å¶„Å≠'; }
    }
    areaSelect.onchange = (e) => fetchWeather(e.target.value);
    init();
</script>
</body>
</html>